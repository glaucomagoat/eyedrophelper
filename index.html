<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eye Drop Scheduler</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#4f46e5; --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    header{position:sticky;top:0;backdrop-filter:saturate(180%) blur(8px);background:rgba(255,255,255,.8);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1100px;margin:0 auto;padding:12px 16px}
    h1{font-size:22px;margin:8px 0}
    h2{font-size:18px;margin:0 0 8px 0}
    .btn{border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.dark{background:#0f172a;color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border)}
    .grid{display:grid;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 1px 2px rgba(15,23,42,.04)}
    label{display:block;font-size:14px;margin:6px 0 4px}
    input[type="text"],input[type="date"],input[type="time"],input[type="number"],select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border)}
    .catalog{max-height:360px;overflow:auto;padding-right:6px;position:relative}
    .groupHead{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);padding:4px 6px;font-weight:700;font-size:12px;color:#334155;z-index:2}
    .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:none}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px}
    .cap{width:12px;height:12px;border-radius:999px;border:1px solid #0f172a33}
    .slot-btn{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;font-size:13px;cursor:pointer}
    .slot-btn.active{background:var(--primary);border-color:var(--primary);color:#fff}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{width:18px;height:18px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
    thead th{background:#f1f5f9}
    .small{font-size:12px;color:var(--muted)}
    .legend{display:flex;flex-wrap:wrap;gap:8px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .payload{word-break:break-all;font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;font-size:11px}
    .entry{display:flex;align-items:center;gap:8px;margin:4px 0}
    .entry .colorname{font-size:11px;color:var(--muted)}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <div>
      <h1 style="margin-bottom:2px">Eye Drop Scheduler</h1>
      <div class="small">Created by Michael C Yang MD</div>
    </div>
    <div class="actions">
      <button class="btn dark" id="downloadJsonBtn">Download JSON</button>
      <button class="btn primary" id="printBtnEn">Print PDF (English)</button><button class="btn dark" id="printBtnEs">Print PDF (Spanish)</button>
    </div>
  </div>
</header>

<main class="container grid">
  <section class="card">
    <h2>Patient & Timing</h2>
    <label>Patient name</label>
    <input id="patientName" type="text" placeholder="e.g., John Doe">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <label>Start date</label>
        <input id="startDate" type="date">
      </div>
      <div>
        <label>Duration (days)</label>
        <input id="durationDays" type="number" min="1" value="28">
      </div>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <label>Morning time ‚è∞</label>
        <input id="t_morning" type="time" value="08:00">
      </div>
      <div>
        <label>Noon time ‚òÄÔ∏è</label>
        <input id="t_noon" type="time" value="12:00">
      </div>
      <div>
        <label>Evening time üåô</label>
        <input id="t_evening" type="time" value="18:00">
      </div>
      <div>
        <label>Bedtime üõèÔ∏è</label>
        <input id="t_bedtime" type="time" value="22:00">
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2 style="margin:0">Medication Catalog</h2>
        <button class="btn ghost" id="addCustomMedBtn">+ Custom med</button>
      </div>
      <div class="small" style="margin:6px 0 10px">Note: Cap colors can vary by country/manufacturer. Verify with bottle/label.</div>
      <div id="catalogControls" style="position:sticky;top:0;background:#fff;padding:8px 0 10px;border-bottom:1px solid var(--border);z-index:1">
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <input id="catalogSearch" type="text" placeholder="Search brand or generic‚Ä¶" style="flex:1;min-width:220px;padding:8px 10px;border:1px solid var(--border);border-radius:10px">
    <label class="small" style="display:flex;align-items:center;gap:6px"><input id="toggleFavorites" type="checkbox"> ‚≠ê Favorites</label>
    <label class="small" style="display:flex;align-items:center;gap:6px"><input id="toggleSelectedFirst" type="checkbox"> Selected first</label>
  </div>
  <div id="filterChips" class="legend" style="margin-top:8px"></div>
  <div id="colorIndex" class="legend" style="margin-top:8px"></div>
</div>

      <div class="catalog" id="catalog"></div>
      <div id="catalogEmpty" class="small" style="display:none;color:#b45309">No medications available.</div>
    </div>
  </section>

  <section>
    <div class="card">
      <h2>Selected Drops & Frequencies</h2>
      <div id="selectedEmpty" class="small">Select medications from the catalog to start building the schedule.</div>
      <div id="selectedList" style="display:none"></div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:16px">
      <div class="card">
        <h2>QR for Patient App</h2>
        <p class="small">Scan in the companion iPhone app to import the regimen and set reminders.</p>
        <div id="qrcode" style="background:#fff;display:inline-block;padding:12px;border:1px solid var(--border);border-radius:12px"></div>
        <div class="payload" id="payloadPreview" style="margin-top:8px"></div>
      </div>
      <div class="card" id="printableCard"></div>
    </div>
  </section>
</main>

<section class="container" style="margin-top:12px">
  <div class="card">
    <h2>PDF Preview</h2>
    <div class="small" style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:8px"><span>Preview the PDF exactly as it will export.</span><div id="langToggle" class="actions"><button class="btn ghost" id="toggleEN" aria-pressed="true">EN</button><button class="btn ghost" id="toggleES" aria-pressed="false">ES</button></div></div>
    <div id="pdfPreview" style="height:420px; overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff; padding:8px; display:flex; gap:12px; flex-direction:column"></div>
    <div id="pdfMeta" class="small" style="margin-top:8px;color:var(--muted)"></div>
    <div class="actions" style="margin-top:10px">
      <button class="btn ghost" id="refreshPreview">Refresh preview</button>
      <button class="btn primary" id="downloadPdfBtn">Download PDF</button>
    </div>
  </div>
</section>

<script>
// ---------- Minimal polyfills for older Safari ----------
if (!Array.from) { Array.from = function (arrLike) { return [].slice.call(arrLike); }; }
if (typeof Object.assign != 'function') {
  Object.assign = function(target) {
    if (target == null) { throw new TypeError('Cannot convert undefined or null to object'); }
    target = Object(target);
    for (var index = 1; index < arguments.length; index++) {
      var source = arguments[index];
      if (source != null) {
        for (var key in source) {
          if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; }
        }
      }
    }
    return target;
  };
}

// ---------------- Data & State ----------------

// --- Catalog filters + favorites ---
function saveFavs(){ try{ localStorage.setItem('gds_favs', JSON.stringify(favorites)); }catch(e){} }
function loadFavs(){ try{ var s = localStorage.getItem('gds_favs'); return s? JSON.parse(s) : {}; }catch(e){ return {}; } }
var favorites = loadFavs();
var filters = { q:'', color:null, cls:null, showFavs:false, selectedFirst:false };

function medMatches(opt){
  var q = (filters.q||'').trim().toLowerCase();
  if(q){ var hay = (opt.name||'').toLowerCase(); if(hay.indexOf(q)===-1) return false; }
  if(filters.color && String(opt.capColor||'').toLowerCase()!==filters.color) return false;
  if(filters.cls){ var c=(opt.medClass||'').toLowerCase(); if(c.indexOf(filters.cls)===-1) return false; }
  if(filters.showFavs && !favorites[opt.id]) return false;
  return true;
}
function groupByColor(items){
  var groups = {}; var order = COLOR_ORDER.slice();
  for(var i=0;i<items.length;i++){ var c=String(items[i].capColor||'').toLowerCase(); if(!groups[c]) groups[c]=[]; groups[c].push(items[i]); if(order.indexOf(c)===-1) order.push(c); }
  return {groups:groups, order:order};
}
function makeChip(text, active){ return '<span class="chip" style="cursor:pointer;background:'+(active?'#eef2ff':'#fff')+'">'+text+'</span>'; }

var SLOT_LABEL = {
  morning: 'Morning ‚è∞',
  midmorning: 'Mid-morning',
  noon: 'Noon ‚òÄÔ∏è',
  lateafternoon: 'Late afternoon',
  evening: 'Evening üåô',
  bedtime: 'Bedtime üõèÔ∏è'
};
var SLOT_ORDER = ['morning','midmorning','noon','lateafternoon','evening','bedtime'];



// ---- Persistent frequency helpers (do not remove) ----
function freqTextEN(reg, times){
  try{
    var color = String(reg.capColor||'').toLowerCase();
    if(color==='teal') return '1x / bedtime';
    var n = (reg.slots&&reg.slots.length)||0;
    if(n===1 && reg.slots[0]==='bedtime') return '1x / bedtime';
    if(n>0) return n + 'x / day';
    return '';
  }catch(e){ return ''; }
}
function freqTextES(reg, times){
  try{
    var color = String(reg.capColor||'').toLowerCase();
    if(color==='teal') return '1x / noche';
    var n = (reg.slots&&reg.slots.length)||0;
    if(n===1 && reg.slots[0]==='bedtime') return '1x / noche';
    if(n>0) return n + 'x / d√≠a';
    return '';
  }catch(e){ return ''; }
}
// ===== Spanish helpers + preview rendering + notes translation =====
var PREVIEW_LANG = 'en';

var SLOT_LABEL_ES = {
  morning: 'Ma√±ana ‚è∞',
  midmorning: 'Media ma√±ana',
  noon: 'Mediod√≠a ‚òÄÔ∏è',
  lateafternoon: 'Tarde',
  evening: 'Noche üåô',
  bedtime: 'Antes de dormir üõèÔ∏è'
};

function toAmPm_ES(hhmm){
  if(!hhmm) return '';
  var p = (hhmm+'').split(':');
  var h = parseInt(p[0],10), m = p[1]||'00';
  var suf = h>=12 ? 'p. m.' : 'a. m.';
  var h12 = h%12; if(h12===0) h12=12;
  return h12+':'+m+' '+suf;
}
function eyeFull_ES(code){
  var raw = String(code||'OU');
  var c = raw.toUpperCase();
  if(raw==='1pill') return '1 tableta (250 mg)';
  if(raw==='2pills') return '2 tabletas (500 mg)';
  if(c==='OD') return 'Ojo derecho';
  if(c==='OS') return 'Ojo izquierdo';
  return 'Ambos ojos';
}
var COLOR_ES = {
  teal:'verde azulado',
  yellow:'amarillo',
  purple:'morado',
  orange:'naranja',
  blue:'azul',
  lightgreen:'verde claro',
  white:'blanco',
  pink:'rosa',
  gray:'gris',
  brown:'marr√≥n',
  black:'negro',
  tan:'beige'
};
function getCapLabel_ES(obj){
  if(obj.capLabel){
    if(String(obj.capLabel).toLowerCase()==='tube') return 'Tubo';
    return obj.capLabel;
  }
  var n = String(obj.capColor||'').toLowerCase();
  return (COLOR_ES[n] || n);
}

// Lightweight English‚ÜíSpanish translator for Notes (phrase+word map).
function translateNotesToSpanish(s){
  if(!s) return '';
  var txt = String(s);
  // Phrase-level replacements first (case-insensitive)
  var phrases = [
    [/wait\s*3[\-\u2013]?\s*5\s*minutes\s*between\s*(each\s*)?(eye\s*)?drops?/gi, 'Espere 3‚Äì5 minutos entre cada gota'],
    [/take with meals/gi, 'T√≥melo con las comidas'],
    [/stay hydrated/gi, 'Mant√©ngase hidratado'],
    [/can cause increased urination/gi, 'Puede causar aumento de la micci√≥n'],
    [/tingling in (the )?fingers\/toes/gi, 'hormigueo en los dedos de las manos y los pies'],
    [/altered taste/gi, 'alteraci√≥n del gusto'],
    [/upset stomach/gi, 'malestar estomacal'],
    [/every other day/gi, 'd√≠a por medio'],
    [/every (\d+)\s*hours?/gi, 'cada $1 horas'],
    [/every (\d+)\s*minutes?/gi, 'cada $1 minutos'],
    [/before bed(time)?/gi, 'antes de dormir'],
    [/(right|left) eye only/gi, function(m){ return /right/i.test(m)?'solo ojo derecho':'solo ojo izquierdo'; }],
    [/both eyes/gi, 'ambos ojos'],
    [/do not touch (the )?tip to eye/gi, 'no toque la punta con el ojo'],
    [/shake well/gi, 'agite bien'],
    [/refrigerate/gi, 'refrigerar'],
    [/contact lenses/gi, 'lentes de contacto'],
    [/remove contacts before use/gi, 'retire los lentes antes de usar'],
    [/use as needed/gi, 'usar seg√∫n sea necesario']
  ];
  phrases.forEach(function(p){ txt = txt.replace(p[0], p[1]); });

  // Word-level replacements
  var dict = {
    'wait':'espere','minute':'minuto','minutes':'minutos','hour':'hora','hours':'horas',
    'between':'entre','each':'cada','drop':'gota','drops':'gotas',
    'eye':'ojo','eyes':'ojos','right':'derecho','left':'izquierdo','both':'ambos',
    'with':'con','meals':'comidas','food':'alimentos','water':'agua',
    'before':'antes','after':'despu√©s','bedtime':'dormir','morning':'ma√±ana','noon':'mediod√≠a','evening':'noche',
    'pain':'dolor','redness':'enrojecimiento','blur':'visi√≥n borrosa','vision':'visi√≥n',
    'contact':'contacto','lenses':'lentes','use':'usar','needed':'necesario',
    'every':'cada','day':'d√≠a','days':'d√≠as','week':'semana','weeks':'semanas',
    'increase':'aumento','urination':'micci√≥n','tingling':'hormigueo','fingers':'dedos','toes':'pies',
    'taste':'gusto','stomach':'est√≥mago','nausea':'n√°useas','headache':'dolor de cabeza',
    'withhold':'suspender','resume':'reanudar','if':'si','symptoms':'s√≠ntomas','worsen':'empeoran',
    'avoid':'evite','driving':'conducir','after instillation':'despu√©s de la instilaci√≥n'
  };
  // Replace standalone words while preserving basic capitalization
  txt = txt.replace(/\b([A-Za-z]+)\b/g, function(_, w){
    var lower = w.toLowerCase();
    if(dict[lower]){
      var rep = dict[lower];
      if(w[0]===w[0].toUpperCase()){
        // Capitalize replacement
        rep = rep.charAt(0).toUpperCase() + rep.slice(1);
      }
      return rep;
    }
    return w;
  });

  // Normalize spaces
  txt = txt.replace(/\s+/g,' ').trim();
  // Ensure ending period if original had one
  return txt;
}

function renderPerMedTables_ES(wrapper, payload, opts){
  opts = opts || {}; var hidePatientLine = !!opts.hidePatientLine;
  var start = new Date(payload.startDate);
  var dayIndex = 0;
  var dayRegs = activeSlotsForDay(payload.regimen, dayIndex);
  var regsSorted = sortByColorThenName(dayRegs);
  var slotsAll = activeSlotsSet(dayRegs);
  var sorted = sortSlotsChrono(slotsAll, payload.times);
  var slotsChunks = chunk(sorted, 4);

  var top = document.createElement('div');
  top.innerHTML = '<div style="font-weight:700">Horario de Medicaci√≥n</div>'+
    '<div class="small">Espere 3‚Äì5 minutos entre cada gota.</div>'+
    (hidePatientLine ? '' : '<div class="small">'+(payload.patientName||'Paciente')+' ‚Ä¢ '+fmtDate(start)+'</div>');
  wrapper.appendChild(top);

  for(var c=0;c<slotsChunks.length;c++){
    var subset = slotsChunks[c];
    var table = document.createElement('table');
    var thead = document.createElement('thead');
    var trh = document.createElement('tr');
    var thMed = document.createElement('th'); thMed.textContent = 'Medicamento'; trh.appendChild(thMed);
    subset.forEach(function(slot){
      var th = document.createElement('th'); th.innerHTML = SLOT_LABEL_ES[slot] + '<div class="small">' + toAmPm_ES(payload.times[slot]) + '</div>';
      trh.appendChild(th);
    });
    thead.appendChild(trh); table.appendChild(thead);
    var tbody = document.createElement('tbody');

    regsSorted.forEach(function(r){
      var tr = document.createElement('tr');
      var tdMed = document.createElement('td');
      var esNotes = translateNotesToSpanish(r.notes||'');
      tdMed.innerHTML = svgDot(r.capColor, 10) + ' ' + '<strong>' + r.name + '</strong>' + ' <span class=\"small\">('+(getCapLabel_ES(r)||'‚Äî')+', '+eyeFull_ES(r.eye)+')</span>' + '<div class=\"small\" style=\"font-weight:700\"><div style="font-size:16px;font-weight:bold">' + frequencyLabelES(r.slots||[]) + '</div>';
      if((r.notes||'').trim()){
        var noteEl=document.createElement('div');
        noteEl.className='small'; noteEl.style.color='#475569';
        noteEl.textContent= esNotes; tdMed.appendChild(noteEl);
      }
      tr.appendChild(tdMed);
      subset.forEach(function(slot){
        var td = document.createElement('td');
        if(slotHas(r.slots||[], slot)){
          td.innerHTML = svgDot(r.capColor, 10) + ' ' + (getCapLabel_ES(r)||'') + ' ‚Äî ' + eyeFull_ES(r.eye);
        } else {
          td.innerHTML = '<span class="small">‚Äî</span>';
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrapper.appendChild(table);
    if(c < slotsChunks.length-1){
      var sep = document.createElement('div'); sep.className='small'; sep.style.margin='6px 0 12px'; sep.textContent='Contin√∫a ‚Üí';
      wrapper.appendChild(sep);
    }
  }
}

function buildTaperSummaryHTML_ES(payload){
  var start = new Date(payload.startDate);
  var times = payload.times;
  function esc(s){ return String(s||'').replace(/[&<>]/g, function(m){ return ({'&':'&amp;','<':'&gt;'}[m]); }); }
  function formatRange(from, days){
    var a = new Date(from);
    var b = new Date(from); b.setDate(b.getDate()+days-1);
    return esc(a.toLocaleDateString()) + ' ‚Äì ' + esc(b.toLocaleDateString());
  }
  function slotLabelList(slots){
    if(!slots||!slots.length) return '‚Äî';
    var arr = []; for(var i=0;i<slots.length;i++){ var s=slots[i]; arr.push(SLOT_LABEL_ES[s] + ' (' + toAmPm_ES(times[s]) + ')'); }
    return arr.join(', ');
  }
  var out = ''; var any = false;
  payload.regimen.forEach(function(r){
    if(r.taper && r.taper.enabled && r.taper.steps && r.taper.steps.length){
      any = true;
      out += '<div style="margin-top:10px"><div style="font-weight:700;margin-bottom:6px">';
      out += svgDot(r.capColor, 10) + r.name + ' <span class=\"small\">(' + eyeFull_ES(r.eye) + ')</span></div>';
      out += '<table style="width:100%;border-collapse:collapse;font-size:14px"><thead><tr>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">Semana</th>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">Fechas</th>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">N¬∫ al d√≠a</th>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">Cu√°ndo</th>';
      out += '</tr></thead><tbody>';
      var cursor = new Date(start);
      var weekDays = 0;
      for(var i=0;i<r.taper.steps.length;i++){
        var step = r.taper.steps[i];
        out += '<tr>';
        var wStart = Math.floor(weekDays/7)+1;
        var wEnd = Math.floor((weekDays + step.days - 1)/7)+1;
        var weekLabel = (wStart===wEnd) ? ('Semana ' + wStart) : ('Semanas ' + wStart + '-' + wEnd);
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+weekLabel+'</td>';
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+formatRange(cursor, step.days)+'</td>';
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+(step.slots?step.slots.length:0)+'</td>';
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+esc(slotLabelList(step.slots))+'</td>';
        out += '</tr>';
        weekDays += step.days;
        cursor.setDate(cursor.getDate()+step.days);
      }
      out += '</tbody></table></div>';
    }
  });
  if(!any) return '';
  return '<h2 style="font-size:18px;margin:14px 0 6px">Plan de reducci√≥n (rangos de fechas)</h2>' + out;
}

function generatePrintHTML_ES(payload){
  function esc(s){ return String(s||'').replace(/[&<>]/g, function(m){ return ({'&':'&amp;','<':'&gt;'}[m]); }); }
  var start = new Date(payload.startDate);
  var head = '<!doctype html><html><head><meta charset="utf-8"><title>Horario de Medicaci√≥n</title>' +
  '<style>'+cssForcePrintColors()+' :root{--text:#0f172a;--muted:#475569;--border:#e2e8f0}*{box-sizing:border-box} body{margin:28px;color:var(--text);font:17px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}h1{font-size:22px;margin:0 0 6px} .small{color:var(--muted);font-size:14px}table{width:100%;border-collapse:collapse;font-size:16px;margin-top:10px}th,td{border:1px solid var(--border);padding:10px;vertical-align:top;text-align:left}thead th{background:#f1f5f9}.entry{display:flex;align-items:center;gap:8px;margin:3px 0}.legend{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 12px}.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}</style></head><body>';
  var body = '';
  body += '<h1>Horario de Medicaci√≥n</h1>';
  body += '<div class="small">Espere 3‚Äì5 minutos entre cada gota.</div>';
  body += '<div style="font-size:16px;font-weight:600;margin-top:4px">' + 'Fecha de hoy: ' + esc(new Date().toLocaleDateString()) + '</div>';

  var dayIndex = 0;
  var dayRegs = activeSlotsForDay(payload.regimen, dayIndex);
  var regsSorted = sortByColorThenName(dayRegs);
  var slotsAll = activeSlotsSet(dayRegs);
  var sorted = sortSlotsChrono(slotsAll, payload.times);
  var slotsChunks = chunk(sorted, 4);

  for(var c=0;c<slotsChunks.length;c++){
    var subset = slotsChunks[c];
    body += '<table><thead><tr><th>Medicamento</th>';
    for(var i=0;i<subset.length;i++){
      var slot = subset[i];
      body += '<th>'+SLOT_LABEL_ES[slot]+'<div class="small">'+esc(toAmPm_ES(payload.times[slot]))+'</div></th>';
    }
    body += '</tr></thead><tbody>';
    for(var r=0;r<regsSorted.length;r++){
      var reg = regsSorted[r];
      var esNotes = translateNotesToSpanish(reg.notes||'');
      body += '<tr><td>'+svgDot(reg.capColor, 12)+' <span><strong>'+esc(reg.name)+'</strong></span> <span class="small">('+esc(getCapLabel_ES(reg)||'‚Äî')+', '+esc(eyeFull_ES(reg.eye))+')</span>' + '<div class="small" style="font-weight:700"><div style="font-size:16px;font-weight:bold">' + frequencyLabelES(reg.slots||[]) + '</div>' + (reg.notes && reg.notes.trim() ? ('<div class="small">'+esc(esNotes)+'</div>') : '') + '</td>';
      for(var i=0;i<subset.length;i++){
        var slot2 = subset[i];
        if(slotHas(reg.slots||[], slot2)){
          body += '<td>'+svgDot(reg.capColor, 12)+' '+esc(getCapLabel_ES(reg)||'')+' ‚Äî '+esc(eyeFull_ES(reg.eye))+'</td>';
        } else {
          body += '<td><span class="small">‚Äî</span></td>';
        }
      }
      body += '</tr>';
    }
    body += '</tbody></table>';
    if(c < slotsChunks.length-1){ body += '<div class="small" style="margin:6px 0 12px">Contin√∫a ‚Üí</div>'; }
  }

  body += buildTaperSummaryHTML_ES(payload);
  var foot = '<scr' + 'ipt>window.onload=function(){window.print(); setTimeout(function(){window.close();}, 200);};</scr' + 'ipt></body></html>';
  return head + body + foot;
}

var _pdfCacheES = { blobUrl: null, pages: 0 };
function generatePdfAndPreview_ES(doSave){
  return new Promise(function(resolve, reject){
    try {
      var payload = getPayload();
      var node = (function(){
        var container = document.createElement('div');
        container.style.background = '#fff';
        container.style.color = '#0f172a';
        container.style.font = '14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';
        var nameHeader = document.createElement('div');
        nameHeader.style.fontSize = '22pt';
        nameHeader.style.fontWeight = '700';
        nameHeader.style.margin = '0 0 10px 0';
        nameHeader.textContent = payload.patientName || '';
        if(nameHeader.textContent){ container.appendChild(nameHeader); }
        var dateDiv=document.createElement('div'); dateDiv.style.fontSize='16px'; dateDiv.style.fontWeight='600'; dateDiv.style.margin='0 0 10px 0'; dateDiv.textContent='Fecha de hoy: ' + (new Date()).toLocaleDateString(); container.appendChild(dateDiv);
        var wrap = document.createElement('div');
        renderPerMedTables_ES(wrap, payload, {hidePatientLine:true});
        var taperHTML = buildTaperSummaryHTML_ES(payload);
        if(taperHTML){ var div = document.createElement('div'); div.innerHTML = taperHTML; wrap.appendChild(div); }
        container.appendChild(wrap);
        var tables = container.querySelectorAll('table');
        for(var ti=0; ti<tables.length; ti++){ var t=tables[ti]; t.style.width='100%'; t.style.tableLayout='fixed'; t.style.borderCollapse='collapse'; var cells=t.querySelectorAll('th,td'); for(var ci=0; ci<cells.length; ci++){ var c=cells[ci]; c.style.padding='8px'; c.style.whiteSpace='normal'; c.style.wordBreak='break-word'; c.style.overflowWrap='anywhere'; } }
        return container;
      })();
      var host = document.createElement('div'); host.style.position='fixed'; host.style.left='-99999px'; host.style.top='0'; host.style.background='#fff';
      document.body.appendChild(host); host.appendChild(node);

      var jsPDFCtor = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
      if(!jsPDFCtor || !window.html2canvas){ throw new Error('PDF libs not loaded'); }
      var pdf = new jsPDFCtor({unit:'pt', format:'letter', compress:true});
      var pageWpt = pdf.internal.pageSize.getWidth();
      var pageHpt = pdf.internal.pageSize.getHeight();
      var margin = 36;
      var contentWpt = pageWpt - margin*2;
      var contentHpt = pageHpt - margin*2;
      var pxPerPt = 96/72;
      var contentWpx = Math.round(contentWpt * pxPerPt);
      node.style.width = contentWpx + 'px';

      html2canvas(node, {scale: 2, useCORS: true, backgroundColor: '#ffffff'}).then(function(canvas){
        var imgWpx = canvas.width, imgHpx = canvas.height;
        var k = contentWpt / imgWpx;
        var pageHeightPx = Math.floor(contentHpt / k);
        var pageCount = 0, y = 0;
        while(y < imgHpx){
          var sliceHeight = Math.min(pageHeightPx, imgHpx - y);
          var pageCanvas = document.createElement('canvas'); pageCanvas.width = imgWpx; pageCanvas.height = sliceHeight;
          var ctx = pageCanvas.getContext('2d'); ctx.drawImage(canvas, 0, y, imgWpx, sliceHeight, 0, 0, imgWpx, sliceHeight);
          var imgData = pageCanvas.toDataURL('image/png');
          if(pageCount>0) pdf.addPage();
          var sliceHeightPt = sliceHeight * k;
          pdf.addImage(imgData, 'PNG', margin, margin, contentWpt, sliceHeightPt);
          y += sliceHeight; pageCount++;
        }
        try{ if(_pdfCacheES.blobUrl) URL.revokeObjectURL(_pdfCacheES.blobUrl);}catch(e){}
        var blob = pdf.output('blob'); var url = URL.createObjectURL(blob); _pdfCacheES.blobUrl = url; _pdfCacheES.pages = pageCount;
        if(doSave){
          var name=(payload.patientName||'paciente').replace(/[^a-z0-9_\-]+/ig,'_');
          var date=(new Date(payload.startDate)).toISOString().slice(0,10);
          pdf.save('horario_'+name+'_'+date+'.pdf');
        }
        document.body.removeChild(host);
        resolve({pages:pageCount,url:_pdfCacheES.blobUrl});
      }).catch(function(err){ document.body.removeChild(host); reject(err); });
    } catch(e){ reject(e); }
  });
}

// custom color order for grouping
var COLOR_ORDER = ['teal','yellow','purple','orange','blue','lightgreen','white','pink','gray','brown'];
function colorRank(c){
  var k = String(c||'').toLowerCase();
  var idx = COLOR_ORDER.indexOf(k);
  return idx === -1 ? 999 : idx;
}

var DEFAULT_DROPS = [
  { id:'latanoprost', name:'Xalatan (Latanoprost)', capColor:'teal', medClass:'Glaucoma', freqPresets:[
      {label:'QHS (bedtime)',slots:['bedtime']},
      {label:'QD morning',slots:['morning']}
    ]},
  { id:'vyzulta', name:'Vyzulta (Latanoprostene Bunod)', capColor:'teal', medClass:'Glaucoma', freqPresets:[
      {label:'QHS (bedtime)',slots:['bedtime']}
    ]},
  { id:'bimatoprost', name:'Lumigan (Bimatoprost)', capColor:'teal', medClass:'Glaucoma', freqPresets:[
      {label:'QHS (bedtime)',slots:['bedtime']},
      {label:'QD morning',slots:['morning']}
    ]},

  { id:'timolol', name:'Timoptic (Timolol)', capColor:'yellow', medClass:'Glaucoma', freqPresets:[
      {label:'QD',slots:['morning']},
      {label:'BID (AM/PM)',slots:['morning','evening']}
    ]},

  { id:'brimonidine', name:'Alphagan P (Brimonidine)', capColor:'purple', medClass:'Glaucoma', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']},
      {label:'TID (AM/Noon/PM)',slots:['morning','noon','evening']}
    ]},

  { id:'dorzolamide', name:'Trusopt (Dorzolamide)', capColor:'orange', medClass:'Glaucoma', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']},
      {label:'TID (AM/Noon/PM)',slots:['morning','noon','evening']}
    ]},
  { id:'azopt', name:'Azopt (Brinzolamide)', capColor:'orange', medClass:'Glaucoma', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']},
      {label:'TID (AM/Noon/PM)',slots:['morning','noon','evening']}
    ]},

  { id:'dorzolamide_timolol', name:'Cosopt (Dorzolamide/Timolol)', capColor:'blue', medClass:'Glaucoma', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']}
    ]},
  { id:'brimonidine_timolol', name:'Combigan (Brimonidine/Timolol)', capColor:'blue', medClass:'Glaucoma', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']}
    ]},

  { id:'simbrinza', name:'Simbrinza (Brinzolamide/Brimonidine)', capColor:'lightgreen', medClass:'Glaucoma (combo)', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']},
      {label:'TID (AM/Noon/PM)',slots:['morning','noon','evening']}
    ]},

  { id:'netarsudil', name:'Rhopressa (Netarsudil)', capColor:'white', medClass:'Glaucoma', freqPresets:[
      {label:'QHS (bedtime)',slots:['bedtime']}
    ]},
  { id:'rocklatan', name:'Rocklatan (Netarsudil/Latanoprost)', capColor:'white', medClass:'Glaucoma', freqPresets:[
      {label:'QHS (bedtime)',slots:['bedtime']}
    ]},
  { id:'diamox', name:'Diamox (Acetazolamide)', capColor:'white', medClass:'Oral CAI', freqPresets:[
      {label:'TID (AM/Noon/PM)',slots:['morning','noon','evening']}
    ]},

  { id:'pred_acetate', name:'Pred Forte (Prednisolone Acetate)', capColor:'pink', medClass:'Steroid', freqPresets:[
      {label:'QID',slots:['morning','noon','evening','bedtime']}
    ]},
  { id:'ketorolac', name:'Acular (Ketorolac)', capColor:'gray', medClass:'NSAID', freqPresets:[
      {label:'QID',slots:['morning','noon','evening','bedtime']}
    ]},

  { id:'erythro_oint', name:'Erythromycin Ointment', capColor:'black', capLabel:'Tube', medClass:'Antibiotic (ointment)', freqPresets:[
      {label:'QHS',slots:['bedtime']}
    ]},
  { id:'maxitrol_oint', name:'Maxitrol Ointment', capColor:'black', capLabel:'Tube', medClass:'Antibiotic/Steroid (ointment)', freqPresets:[
      {label:'BID (AM/PM)',slots:['morning','evening']}
    ]},

  { id:'ofloxacin', name:'Ocuflox (Ofloxacin)', capColor:'tan', medClass:'Antibiotic', freqPresets:[
      {label:'QID (AM/Noon/PM/Bedtime)',slots:['morning','noon','evening','bedtime']}
    ]}
,
  { id:'muro', name:'Muro 128 (Sodium Chloride 5%)', capColor:'white', medClass:'Cornea', freqPresets:[
      {label:'QID',slots:['morning','noon','evening','bedtime']},
      {label:'QHS',slots:['bedtime']}
    ]},
  { id:'durezol', name:'Durezol (Difluprednate)', capColor:'pink', medClass:'Steroid', freqPresets:[
      {label:'QID',slots:['morning','noon','evening','bedtime']}
    ]}
];
var catalog = DEFAULT_DROPS.slice();
var selected = [];
var qr = null;

// ---------------- Helpers ----------------
function byId(id){ return document.getElementById(id); }
function setOnclickIfPresent(id, handler){ var el = byId(id); if(el) el.onclick = handler; }
function makeUid(){ return 'u'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
function fmtDate(dt){ return dt.toLocaleDateString(); }
function encodePayload(obj){
  var minified = JSON.stringify(obj);
  return btoa(unescape(encodeURIComponent(minified)));
}
function download(filename, text){
  var blob = new Blob([text], {type:'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function toAmPm(hhmm){
  if(!hhmm) return '';
  var parts = hhmm.split(':');
  var h = parseInt(parts[0],10); var m = parts[1]||'00';
  var ampm = h>=12 ? 'PM' : 'AM';
  var h12 = h%12; if(h12===0) h12=12;
  return h12+':'+m+' '+ampm;
}
function titleCase(s){ return String(s||'').replace(/[_\-]+/g,' ').replace(/\b[a-z]/g,function(m){ return m.toUpperCase(); }); }
function niceColorName(c){ return titleCase(c||''); }
function getCapLabel(obj){ return obj.capLabel ? obj.capLabel : niceColorName(obj.capColor); }
function svgDot(color, size){
  var s = size || 10;
  return '<svg width="'+s+'" height="'+s+'" viewBox="0 0 '+s+' '+s+'" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle; margin-right:6px;"><circle cx="'+(s/2)+'" cy="'+(s/2)+'" r="'+(s/2 - 0.5)+'" fill="'+color+'" stroke="rgba(15,23,42,.2)"/></svg>';
}
function cssForcePrintColors(){ return '*{-webkit-print-color-adjust:exact;print-color-adjust:exact}'; }

function eyeFull(code){
  var raw = String(code||'OU');
  var c = raw.toUpperCase();
  // Special handling for Diamox dosage selections stored in the 'eye' field
  if(raw === '1pill') return '1 Pill (250 mg)';
  if(raw === '2pills') return '2 Pills (500 mg)';
  if(c==='OD') return 'Right Eye';
  if(c==='OS') return 'Left Eye';
  return 'Both Eyes';
}

function getTimes(){
  return {
    morning: byId('t_morning').value || '08:00',
    midmorning: '10:00',
    noon: byId('t_noon').value || '12:00',
    lateafternoon: '16:00',
    evening: byId('t_evening').value || '18:00',
    bedtime: byId('t_bedtime').value || '22:00'
  };
}
function slotHas(slots, slot){ return (slots||[]).indexOf(slot) > -1; }

function frequencyCount(slots){
  var s = slots||[]; return s.length;
}
function frequencyLabelEN(slots){
  var n = frequencyCount(slots);
  if(n<=0) return '';
  // bedtime-only special
  if(n===1 && (slots||[]).indexOf('bedtime')!==-1) return '1x / bedtime';
  return n + 'x / day';
}
function frequencyLabelES(slots){
  var n = frequencyCount(slots);
  if(n<=0) return '';
  if(n===1 && (slots||[]).indexOf('bedtime')!==-1) return '1x / noche';
  return n + 'x / d√≠a';
}

function sortSlotsChrono(slots, times){
  return slots.slice().sort(function(a,b){
    var ia = SLOT_ORDER.indexOf(a), ib = SLOT_ORDER.indexOf(b);
    if(ia!==-1 && ib!==-1 && ia!==ib) return ia-ib;
    function toMin(x){ var t = times[x]; if(!t) return 1e9; var p=t.split(':'); return parseInt(p[0],10)*60+parseInt(p[1],10); }
    return toMin(a) - toMin(b);
  });
}
function sortByColorThenName(arr){
  return arr.slice().sort(function(a,b){
    var ra = colorRank(a.capColor), rb = colorRank(b.capColor);
    if(ra !== rb) return ra - rb;
    var na = a.name.toLowerCase();
    var nb = b.name.toLowerCase();
    if(na < nb) return -1;
    if(na > nb) return 1;
    return 0;
  });
}

// compute day regimen considering taper
function activeSlotsForDay(regimen, dayIndex){
  return regimen.map(function(r){
    if(r.taper && r.taper.enabled && r.taper.steps && r.taper.steps.length){
      var d = dayIndex + 1;
      for(var i=0;i<r.taper.steps.length;i++){
        var step = r.taper.steps[i];
        if(d <= step.days){
          return {id:r.id, name:r.name, capColor:r.capColor, capLabel:r.capLabel, eye:(r.eye||'OU'), slots:step.slots, notes:r.notes||'', medClass:r.medClass};
        } else { d -= step.days; }
      }
      return {id:r.id, name:r.name, capColor:r.capColor, capLabel:r.capLabel, eye:(r.eye||'OU'), slots:[], notes:r.notes||'', medClass:r.medClass};
    } else {
      return {id:r.id, name:r.name, capColor:r.capColor, capLabel:r.capLabel, eye:(r.eye||'OU'), slots:r.slots||[], notes:r.notes||'', medClass:r.medClass};
    }
  });
}
// Payload builder
function getPayload(){
  return {
    type:'glaucoma-drop-schedule',
    version:17,
    patientName: byId('patientName').value || '',
    startDate: byId('startDate').value || new Date().toISOString().slice(0,10),
    durationDays: Math.max(1, parseInt(byId('durationDays').value||'28',10)),
    times: getTimes(),
    regimen: selected.map(function(s){
      return {
        id:s.id, name:s.name, capColor:s.capColor, capLabel:s.capLabel, eye:(s.eye||'OU'), slots:s.slots, notes:s.notes||'', medClass:s.medClass,
        taper: (s.taper && s.taper.enabled) ? {enabled:true,steps:s.taper.steps} : {enabled:false,steps:[]}
      };
    })
  };
}
// chunks array into groups of size n
function chunk(arr, n){
  var out=[]; for(var i=0;i<arr.length;i+=n){ out.push(arr.slice(0+i, n+i)); } return out;
}
// get unique active slots for a day
function activeSlotsSet(dayRegs){
  var set = {}; dayRegs.forEach(function(r){ (r.slots||[]).forEach(function(s){ set[s]=1; }); });
  return Object.keys(set);
}

// ---------- UI renderers ----------
function renderCatalog(){
  var root = byId('catalog'); var empty = byId('catalogEmpty');
  root.innerHTML='';
  if(!catalog || !catalog.length){ empty.style.display='block'; return; } else { empty.style.display='none'; }

function isSelected(id){ for(var i=0;i<selected.length;i++){ if(selected[i].id===id) return true; } return false; }
  var arr=[]; for(var i=0;i<catalog.length;i++){ if(medMatches(catalog[i])) arr.push(catalog[i]); }
  if(filters.selectedFirst){ arr.sort(function(a,b){ var sa=isSelected(a.id)?0:1; var sb=isSelected(b.id)?0:1; if(sa!==sb) return sa-sb; return 0; }); }
  arr = sortByColorThenName(arr);
  var gb = groupByColor(arr);
  for(var gi=0; gi<gb.order.length; gi++){ var color=gb.order[gi]; if(!gb.groups[color]||gb.groups[color].length===0) continue;
    var gWrap=document.createElement('div'); gWrap.id='group_'+color;
    var head=document.createElement('div'); head.className='groupHead'; head.innerHTML='<span style="display:inline-flex;align-items:center;gap:6px">'+svgDot(color,10)+' '+color.charAt(0).toUpperCase()+color.slice(1)+'</span>'; gWrap.appendChild(head);
    for(var k=0;k<gb.groups[color].length;k++){ var opt=gb.groups[color][k];
      var row=document.createElement('div'); row.className='row';
      var left=document.createElement('div');
      left.innerHTML = '<div style="font-weight:600">'+opt.name+'</div>' + '<div class="small">'+(opt.medClass||'')+'</div>' + '<div class="small">Cap: <span class="chip"><span class="cap" style="background:'+opt.capColor+'"></span>'+ (getCapLabel(opt)||'‚Äî') +'</span></div>';
      var btns=document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px'; btns.style.alignItems='center';
      var fav=document.createElement('button'); fav.className='btn ghost'; fav.title='Favorite'; fav.textContent = favorites[opt.id] ? '‚≠ê' : '‚òÜ'; fav.onclick=(function(opt){ return function(){ favorites[opt.id]=!favorites[opt.id]; saveFavs(); renderCatalog(); }; })(opt);
      var addBtn=document.createElement('button'); addBtn.className='btn dark'; addBtn.textContent = 'Add'; addBtn.disabled=false; addBtn.onclick=(function(opt){ return function(){ addDrop(opt); }; })(opt);
      btns.appendChild(fav); btns.appendChild(addBtn);
      row.appendChild(left); row.appendChild(btns); gWrap.appendChild(row);
    }
    root.appendChild(gWrap);
  }
}

function addDrop(opt){
  var slots = [];
  if(opt.freqPresets && opt.freqPresets.length && opt.freqPresets[0].slots){
    slots = opt.freqPresets[0].slots.slice();
  }
  var defaultNotes = (opt.id==='diamox' ? 'Take with meals. Stay hydrated. Can cause increased urination, tingling in fingers/toes, altered taste, upset stomach.' : '');
  var defaultEye = (opt.id==='diamox' ? '1pill' : 'OU');
  selected.push({uid: makeUid(), id: opt.id, name: opt.name, capColor: opt.capColor, capLabel: opt.capLabel, eye: defaultEye, slots: slots, notes: defaultNotes, taper:{enabled:false,steps:[]}, medClass:opt.medClass});
  renderSelected();
}
function removeDrop(uid){
  var out=[]; for(var i=0;i<selected.length;i++){ if(selected[i].uid!==uid) out.push(selected[i]); }
  selected = out; renderSelected();
}
function toggleSlot(uid,slot){
  selected = selected.map(function(s){
    if(s.uid!==uid) return s;
    var has = slotHas(s.slots, slot);
    var next = has ? s.slots.filter(function(t){ return t!==slot; }) : s.slots.concat([slot]);
    return Object.assign({}, s, {slots: next});
  });
  renderSelected();
}
function applyPreset(uid,slots){
  selected = selected.map(function(s){ return s.uid===uid ? Object.assign({}, s, {slots: slots.slice()}) : s; });
  renderSelected();
}
function updateNotes(uid,notes){
  selected = selected.map(function(s){ return s.uid===uid ? Object.assign({}, s, {notes:notes}) : s; });
}
function setTaperEnabled(uid,enabled){
  var med = null; for(var i=0;i<selected.length;i++){ if(selected[i].uid===uid){ med = selected[i]; break; } }
  if(enabled && med){
    if(med.id==='pred_acetate' || med.id==='durezol'){ addCommonTaper(uid,'pred_4422'); return; }
    if(med.id==='ketorolac'){ addCommonTaper(uid,'acular_440'); return; }
  }
  selected = selected.map(function(s){
    return s.uid===uid ? Object.assign({}, s, {taper: Object.assign({}, s.taper||{}, {enabled:enabled})}) : s;
  });
  renderSelected();
}
function addTaperStep(uid, step){
  selected = selected.map(function(s){
    if(s.uid!==uid) return s;
    var steps = (s.taper && s.taper.steps) ? s.taper.steps.slice() : [];
    steps.push(step);
    return Object.assign({}, s, {taper: Object.assign({}, s.taper||{}, {steps: steps})});
  });
  renderSelected();
}
function removeTaperStep(uid, idx){
  selected = selected.map(function(s){
    if(s.uid!==uid) return s;
    var steps = (s.taper && s.taper.steps) ? s.taper.steps.slice() : [];
    steps.splice(idx,1);
    return Object.assign({}, s, {taper: Object.assign({}, s.taper||{}, {steps: steps})});
  });
  renderSelected();
}
function addCommonTaper(uid, type){
  var presets = {
    'pred_4422': [
      {days:14, slots:['morning','noon','evening','bedtime']},
      {days:14, slots:['morning','evening']}
    ],
    'pred_4321': [
      {days:7, slots:['morning','noon','evening','bedtime']},
      {days:7, slots:['morning','noon','evening']},
      {days:7, slots:['morning','evening']},
      {days:7, slots:['bedtime']}
    ],
    'acular_440': [
      {days:14, slots:['morning','noon','evening','bedtime']}
    ]
  };
  var steps = presets[type] || [];
  selected = selected.map(function(s){
    return s.uid===uid ? Object.assign({}, s, {taper:{enabled:true, steps: steps.slice()}}) : s;
  });
  renderSelected();
}

function buildFilterUI(){
  var chips = byId('filterChips'); if(!chips) return;
  // Build class filter chips
  var classes = {}; for(var i=0;i<catalog.length;i++){ var cls=(catalog[i].medClass||'').split('(')[0].trim().toLowerCase(); if(cls) classes[cls]=true; }
  var clsList = Object.keys(classes).sort();
  var htmlCls = '<div class="small" style="margin-right:6px">Classes:</div>';
  htmlCls += makeChip('All', !filters.cls);
  for(var i=0;i<clsList.length;i++){ var t=clsList[i]; htmlCls += makeChip(t.charAt(0).toUpperCase()+t.slice(1), filters.cls===t); }
  chips.innerHTML = htmlCls;
  chips.onclick = function(e){
    var t=e.target; while(t && !t.className.includes('chip')) t=t.parentElement; if(!t) return;
    var label=t.textContent.trim().toLowerCase();
    filters.cls = (label==='all') ? null : label;
    renderCatalog(); buildFilterUI();
  };

  // Build color filter chips
  var idx = byId('colorIndex'); if(idx){
    var htmlIdx = '<div class="small" style="margin-right:6px">Colors:</div>';
    htmlIdx += makeChip('All', !filters.color);
    var seen={}, colorList = COLOR_ORDER.slice();
    for(var j=0;j<catalog.length;j++){ var col=String(catalog[j].capColor||'').toLowerCase(); if(colorList.indexOf(col)===-1 && !seen[col]){ colorList.push(col); seen[col]=true; } }
    for(var j=0;j<colorList.length;j++){ var col=colorList[j]; htmlIdx += makeChip(col.charAt(0).toUpperCase()+col.slice(1), filters.color===col); }
    idx.innerHTML = htmlIdx;
    idx.onclick = function(e){
      var t=e.target; while(t && !t.className.includes('chip')) t=t.parentElement; if(!t) return;
      var label=t.textContent.trim().toLowerCase();
      filters.color = (label==='all') ? null : label;
      renderCatalog(); buildFilterUI();
      var anchor = byId('group_'+(filters.color||'')); if(anchor){ anchor.scrollIntoView({behavior:'smooth', block:'start'}); }
    };
  }

  // Wire search + toggles
  var search = byId('catalogSearch'); if(search){ search.oninput = function(){ filters.q = search.value; renderCatalog(); }; }
  var favT = byId('toggleFavorites'); if(favT){ favT.onchange = function(){ filters.showFavs = favT.checked; renderCatalog(); }; }
  var selFirst = byId('toggleSelectedFirst'); if(selFirst){ selFirst.onchange = function(){ filters.selectedFirst = selFirst.checked; renderCatalog(); }; }
}

function renderQR(){
  var container = byId('qrcode');
  container.innerHTML='';
  var payload = getPayload();
  var enc = encodePayload(payload);
  if (window.QRCode) { qr = new QRCode(container, {text: enc, width:192, height:192}); }
  byId('payloadPreview').textContent = 'Payload: ' + enc.slice(0,120) + '‚Ä¶';
}

function renderSelected(){
  var empty = byId('selectedEmpty');
  var list = byId('selectedList');
  if(selected.length===0){ empty.style.display='block'; list.style.display='none'; }
  else { empty.style.display='none'; list.style.display='block'; }
  list.innerHTML='';
  var sortedSel = sortByColorThenName(selected);
  sortedSel.forEach(function(s){
    var wrap = document.createElement('div');
    wrap.className='card'; wrap.style.marginBottom='12px'; wrap.style.padding='10px';
    var top = document.createElement('div');
    top.style.display='flex'; top.style.alignItems='center'; top.style.justifyContent='space-between';
    top.innerHTML = '<div style="display:flex;align-items:center;gap:10px">' +
      '<span class="cap" style="width:16px;height:16px;background:'+s.capColor+'"></span>' +
      '<div><div style="font-weight:600">'+s.name+'</div><div class="small">Cap: '+(getCapLabel(s)||'‚Äî')+'</div></div>' +
    '</div>';
    var remove = document.createElement('button'); remove.className='btn ghost'; remove.textContent='Remove';
    remove.onclick=function(){ removeDrop(s.uid); };
    top.appendChild(remove);
    wrap.appendChild(top);

    var taperable = (s.medClass==='Steroid' || s.medClass==='NSAID');
    if(taperable){
      var sw = document.createElement('div'); sw.className='switch'; sw.style.marginTop='8px';
      var cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!(s.taper && s.taper.enabled);
      var lbl = document.createElement('span'); lbl.textContent='Use taper schedule';
      cb.onchange=function(){ setTaperEnabled(s.uid, cb.checked); };
      sw.appendChild(cb); sw.appendChild(lbl); wrap.appendChild(sw);
    }

    if(s.taper && s.taper.enabled){
      var help = document.createElement('div'); help.className='small'; help.textContent='Define steps (days + times per day).'; help.style.marginTop='6px'; wrap.appendChild(help);
      var presets = document.createElement('div'); presets.style.marginTop='6px'; presets.style.display='flex'; presets.style.flexWrap='wrap'; presets.style.gap='8px';
      if(s.id==='pred_acetate' || s.id==='durezol'){
        var b1 = document.createElement('button'); b1.className='slot-btn'; b1.textContent='4/4/2/2';
        b1.onclick=function(){ addCommonTaper(s.id,'pred_4422'); };
        var b2 = document.createElement('button'); b2.className='slot-btn'; b2.textContent='4/3/2/1';
        b2.onclick=function(){ addCommonTaper(s.id,'pred_4321'); };
        presets.appendChild(b1); presets.appendChild(b2);
      } else if(s.id==='ketorolac'){
        var k1 = document.createElement('button'); k1.className='slot-btn'; k1.textContent='4/4/0';
        k1.onclick=function(){ addCommonTaper(s.id,'acular_440'); };
        presets.appendChild(k1);
      }
      wrap.appendChild(presets);

      var stepsDiv = document.createElement('div'); stepsDiv.style.marginTop='8px'; stepsDiv.style.display='flex'; stepsDiv.style.flexDirection='column'; stepsDiv.style.gap='8px';
      (s.taper.steps||[]).forEach(function(step, idx){
        var row = document.createElement('div'); row.className='card'; row.style.padding='8px';
        var head = document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
        head.innerHTML = '<div style="font-weight:600">Step '+(idx+1)+': '+step.days+' day(s)</div>';
        var del = document.createElement('button'); del.className='btn ghost'; del.textContent='Remove step';
        del.onclick=function(){ removeTaperStep(s.uid, idx); };
        head.appendChild(del); row.appendChild(head);

        var daysLab = document.createElement('label'); daysLab.textContent='Days';
        var daysInput = document.createElement('input'); daysInput.type='number'; daysInput.min='1'; daysInput.value=step.days;
        daysInput.oninput=function(e){
          var val = Math.max(1, parseInt(e.target.value||'1',10));
          selected = selected.map(function(x){
            if(x.uid!==s.uid) return x;
            var steps = x.taper.steps.slice(); steps[idx] = Object.assign({}, steps[idx], {days: val});
            return Object.assign({}, x, {taper:Object.assign({}, x.taper, {steps:steps})});
          });
          renderPrintable(); renderQR();
        };
        daysInput.style.width='120px'; daysInput.style.margin='6px 0';
        row.appendChild(daysLab); row.appendChild(daysInput);

        var slotsDiv = document.createElement('div'); slotsDiv.style.marginTop='6px'; slotsDiv.style.display='flex'; slotsDiv.style.flexWrap='wrap'; slotsDiv.style.gap='8px';
        Object.keys(SLOT_LABEL).forEach(function(slot){
          var b = document.createElement('button');
          b.className = 'slot-btn ' + (slotHas(step.slots, slot)?'active':''); b.textContent = SLOT_LABEL[slot];
          b.onclick=function(){
            selected = selected.map(function(x){
              if(x.uid!==s.uid) return x;
              var steps = x.taper.steps.slice();
              var has = slotHas(steps[idx].slots, slot);
              steps[idx] = Object.assign({}, steps[idx], { slots: has ? steps[idx].slots.filter(function(t){return t!==slot;}) : steps[idx].slots.concat([slot]) });
              return Object.assign({}, x, {taper:Object.assign({}, x.taper, {steps:steps})});
            });
            renderSelected();
          };
          slotsDiv.appendChild(b);
        });
        row.appendChild(slotsDiv);
        stepsDiv.appendChild(row);
      });
      wrap.appendChild(stepsDiv);

      var addStepBtn = document.createElement('button'); addStepBtn.className='btn ghost'; addStepBtn.textContent='+ Add step';
      addStepBtn.onclick=function(){ addTaperStep(s.id,{days:7, slots:['morning','evening']}); };
      wrap.appendChild(addStepBtn);
    } else {
      var slotsDiv2 = document.createElement('div'); slotsDiv2.style.marginTop='8px'; slotsDiv2.style.display='flex'; slotsDiv2.style.flexWrap='wrap'; slotsDiv2.style.gap='8px';
      Object.keys(SLOT_LABEL).forEach(function(slot){
        var b2 = document.createElement('button');
        b2.className = 'slot-btn ' + (slotHas(s.slots, slot)?'active':''); b2.textContent = SLOT_LABEL[slot];
        b2.onclick=function(){ toggleSlot(s.uid, slot); };
        slotsDiv2.appendChild(b2);
      });
      wrap.appendChild(slotsDiv2);

      var opt = null; for(var i=0;i<catalog.length;i++){ if(catalog[i].id===s.id){ opt=catalog[i]; break; } }
      if(opt && opt.freqPresets && opt.freqPresets.length){
        var presets2 = document.createElement('div'); presets2.style.marginTop='8px'; presets2.style.display='flex'; presets2.style.flexWrap='wrap'; presets2.style.gap='8px';
        opt.freqPresets.forEach(function(p){
          var pb = document.createElement('button'); pb.className='slot-btn'; pb.textContent='Preset: '+p.label;
          pb.onclick=function(){ applyPreset(s.uid, p.slots); };
          presets2.appendChild(pb);
        });
        wrap.appendChild(presets2);
      }
    }

    var lab = document.createElement('label'); lab.textContent='Notes (optional)'; lab.style.marginTop='8px';
    var input = document.createElement('input'); input.type='text'; input.placeholder='e.g., Wait 5 min between drops'; input.value=s.notes||'';
    input.oninput=function(e){ updateNotes(s.uid, e.target.value); };
    input.style.width='100%'; input.style.padding='10px 12px'; input.style.border='1px solid var(--border)'; input.style.borderRadius='12px';
    wrap.appendChild(lab); wrap.appendChild(input);

    // Eye selector (buttons: Both/Right/Left)
    (function(){
      if(s.id==='diamox'){
        var pillRow = document.createElement('div');
        pillRow.style.marginTop='8px';
        pillRow.style.display='flex';
        pillRow.style.alignItems='center';
        pillRow.style.gap='8px';
        var pillLab = document.createElement('label');
        pillLab.textContent='Dosage';
        pillLab.style.margin='0';
        function mkPillBtn(label, val){
          var b = document.createElement('button');
          b.className = 'slot-btn';
          b.textContent = label;
          if((s.eye||'1pill')===val) b.classList.add('active');
          b.onclick = function(){
            selected = selected.map(function(x){ return x.uid===s.uid ? Object.assign({}, x, {eye: val}) : x; });
            renderSelected();
          };
          return b;
        }
        var group = document.createElement('div');
        group.style.display='flex'; group.style.gap='6px'; group.style.flexWrap='wrap';
        group.appendChild(mkPillBtn('1 Pill (250 mg)', '1pill'));
        group.appendChild(mkPillBtn('2 Pills (500 mg)', '2pills'));
        pillRow.appendChild(pillLab);
        pillRow.appendChild(group);
        wrap.appendChild(pillRow);
      } else {
        var eyeRow = document.createElement('div');
        eyeRow.style.marginTop='8px';
        eyeRow.style.display='flex';
        eyeRow.style.alignItems='center';
        eyeRow.style.gap='8px';
        var eyeLab = document.createElement('label');
        eyeLab.textContent='Eye';
        eyeLab.style.margin='0';
        function mkBtn(label, val){
          var b = document.createElement('button');
          b.className = 'slot-btn';
          b.textContent = label;
          if((s.eye||'OU')===val) b.classList.add('active');
          b.onclick = function(){
            selected = selected.map(function(x){ return x.uid===s.uid ? Object.assign({}, x, {eye: val}) : x; });
            renderSelected();
          };
          return b;
        }
        var group = document.createElement('div');
        group.style.display='flex'; group.style.gap='6px'; group.style.flexWrap='wrap';
        group.appendChild(mkBtn('Both Eyes', 'OU'));
        group.appendChild(mkBtn('Right Eye', 'OD'));
        group.appendChild(mkBtn('Left Eye', 'OS'));
        eyeRow.appendChild(eyeLab);
        eyeRow.appendChild(group);
        wrap.appendChild(eyeRow);
      }

        })();
    list.appendChild(wrap);
  });
  renderQR();
  renderPrintable();
}

function renderPerMedTables(wrapper, payload, opts){
  opts = opts || {}; var hidePatientLine = !!opts.hidePatientLine;
  var start = new Date(payload.startDate);
  var dayIndex = 0;
  var dayRegs = activeSlotsForDay(payload.regimen, dayIndex);
  var regsSorted = sortByColorThenName(dayRegs);
  var slotsAll = activeSlotsSet(dayRegs);
  var sorted = sortSlotsChrono(slotsAll, payload.times);
  var slotsChunks = chunk(sorted, 4); // max 4 slot columns per table

  var top = document.createElement('div');
  top.innerHTML = '<div style="font-weight:700">Medication Schedule</div>'+
    '<div class="small">Please wait 3-5 minutes between each eye drop.</div>'+
    (hidePatientLine ? '' : '<div class="small">'+(payload.patientName||'Patient')+' ‚Ä¢ '+fmtDate(start)+'</div>');
  wrapper.appendChild(top);

  for(var c=0;c<slotsChunks.length;c++){
    var subset = slotsChunks[c];
    var table = document.createElement('table');
    var thead = document.createElement('thead');
    var trh = document.createElement('tr');
    var thMed = document.createElement('th'); thMed.textContent = 'Medication'; trh.appendChild(thMed);
    subset.forEach(function(slot){
      var th = document.createElement('th'); th.innerHTML = SLOT_LABEL[slot] + '<div class="small">' + toAmPm(payload.times[slot]) + '</div>';
      trh.appendChild(th);
    });
    thead.appendChild(trh); table.appendChild(thead);
    var tbody = document.createElement('tbody');

    regsSorted.forEach(function(r){
      var tr = document.createElement('tr');
      var tdMed = document.createElement('td');
      tdMed.innerHTML = svgDot(r.capColor, 10) + ' ' + '<strong>' + r.name + '</strong>' + ' <span class=\"small\">('+(getCapLabel(r)||'‚Äî')+', '+eyeFull(r.eye)+')</span>' + '<div class=\"small\" style=\"font-weight:700\"><div style="font-size:16px;font-weight:bold">' + frequencyLabelEN(r.slots||[]) + '</div>';
      if((r.notes||'').trim()){
        var noteEl=document.createElement('div');
        noteEl.className='small'; noteEl.style.color='#475569';
        noteEl.textContent=r.notes; tdMed.appendChild(noteEl);
      }
      tr.appendChild(tdMed);
      subset.forEach(function(slot){
        var td = document.createElement('td');
        if(slotHas(r.slots||[], slot)){
          td.innerHTML = svgDot(r.capColor, 10) + ' ' + (getCapLabel(r)||'') + ' ‚Äî ' + eyeFull(r.eye);
        } else {
          td.innerHTML = '<span class="small">‚Äî</span>';
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrapper.appendChild(table);

    if(c < slotsChunks.length-1){
      var sep = document.createElement('div'); sep.className='small'; sep.style.margin='6px 0 12px'; sep.textContent='Continued ‚Üí';
      wrapper.appendChild(sep);
    }
  }
}

function renderPrintable(){
  var card = byId('printableCard'); card.innerHTML='';
  var payload = getPayload();
  var wrapper = document.createElement('div');
  if(PREVIEW_LANG==='es'){
    renderPerMedTables_ES(wrapper, payload);
    var taperHTML_ES = buildTaperSummaryHTML_ES(payload);
    if(taperHTML_ES){ var divES = document.createElement('div'); divES.innerHTML = taperHTML_ES; wrapper.appendChild(divES); }
  } else {
    renderPerMedTables(wrapper, payload);
    var taperHTML = buildTaperSummaryHTML(payload);
    if(taperHTML){ var div = document.createElement('div'); div.innerHTML = taperHTML; wrapper.appendChild(div); }
  }
  card.appendChild(wrapper);
}

// ---------- PRINT (per-med rows + overflow sections) ----------
function buildTaperSummaryHTML(payload){
  var start = new Date(payload.startDate);
  var times = payload.times;
  function esc(s){ return String(s||'').replace(/[&<>]/g, function(m){ return ({'&':'&amp;','<':'&gt;'}[m]); }); }
  function formatRange(from, days){
    var a = new Date(from);
    var b = new Date(from); b.setDate(b.getDate()+days-1);
    return esc(a.toLocaleDateString()) + ' ‚Äì ' + esc(b.toLocaleDateString());
  }
  function slotLabelList(slots){
    if(!slots||!slots.length) return '‚Äî';
    var arr = []; for(var i=0;i<slots.length;i++){ var s=slots[i]; arr.push(SLOT_LABEL[s] + ' (' + toAmPm(times[s]) + ')'); }
    return arr.join(', ');
  }
  var out = '';
  var any = false;
  payload.regimen.forEach(function(r){
    if(r.taper && r.taper.enabled && r.taper.steps && r.taper.steps.length){
      any = true;
      out += '<div style="margin-top:10px"><div style="font-weight:700;margin-bottom:6px">';
      out += svgDot(r.capColor, 10) + r.name + ' <span class=\"small\">(' + eyeFull(r.eye) + ')</span></div>';
      out += '<table style="width:100%;border-collapse:collapse;font-size:14px"><thead><tr>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">Week #</th>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">Dates</th>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9"># per day</th>';
      out += '<th style="border:1px solid #e2e8f0;padding:8px;text-align:left;background:#f1f5f9">When</th>';
      out += '</tr></thead><tbody>';
      var cursor = new Date(start);
      var weekDays = 0; // counts elapsed days to compute week numbers
      for(var i=0;i<r.taper.steps.length;i++){
        var step = r.taper.steps[i];
        out += '<tr>';
        var wStart = Math.floor(weekDays/7)+1;
        var wEnd = Math.floor((weekDays + step.days - 1)/7)+1;
        var weekLabel = (wStart===wEnd) ? ('Week ' + wStart) : ('Weeks ' + wStart + '-' + wEnd);
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+weekLabel+'</td>';
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+formatRange(cursor, step.days)+'</td>';
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+(step.slots?step.slots.length:0)+'</td>';
        out += '<td style="border:1px solid #e2e8f0;padding:8px">'+esc(slotLabelList(step.slots))+'</td>';
        out += '</tr>';
        weekDays += step.days;
        cursor.setDate(cursor.getDate()+step.days);
      }
      out += '</tbody></table></div>';
    }
  });
  if(!any) return '';
  return '<h2 style="font-size:18px;margin:14px 0 6px">Taper plan (date ranges)</h2>' + out;
}

function generatePrintHTML(payload){
  function esc(s){ return String(s||'').replace(/[&<>]/g, function(m){ return ({'&':'&amp;','<':'&gt;'}[m]); }); }
  var start = new Date(payload.startDate);
  var head = '<!doctype html><html><head><meta charset="utf-8"><title>Medication Schedule</title>' +
  '<style>'+cssForcePrintColors()+' :root{--text:#0f172a;--muted:#475569;--border:#e2e8f0}*{box-sizing:border-box} body{margin:28px;color:var(--text);font:17px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}h1{font-size:22px;margin:0 0 6px} .small{color:var(--muted);font-size:14px}table{width:100%;border-collapse:collapse;font-size:16px;margin-top:10px}th,td{border:1px solid var(--border);padding:10px;vertical-align:top;text-align:left}thead th{background:#f1f5f9}.entry{display:flex;align-items:center;gap:8px;margin:3px 0}.legend{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 12px}.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}</style></head><body>';
  var body = '';
  body += '<h1>Medication Schedule</h1>';
  body += '<div class="small">Please wait 3-5 minutes between each eye drop.</div>';
  body += '<div style="font-size:16px;font-weight:600;margin-top:4px">' + ' ' + esc(new Date().toLocaleDateString()) + '</div>';

  // Build per-med tables with overflow columns (chronological order, meds grouped by color order)
  var dayIndex = 0;
  var dayRegs = activeSlotsForDay(payload.regimen, dayIndex);
  var regsSorted = sortByColorThenName(dayRegs);
  var slotsAll = activeSlotsSet(dayRegs);
  var sorted = sortSlotsChrono(slotsAll, payload.times);
  var slotsChunks = chunk(sorted, 4); // 4 columns per section

  for(var c=0;c<slotsChunks.length;c++){
    var subset = slotsChunks[c];
    body += '<table><thead><tr><th>Medication</th>';
    for(var i=0;i<subset.length;i++){
      var slot = subset[i];
      body += '<th>'+SLOT_LABEL[slot]+'<div class="small">'+esc(toAmPm(payload.times[slot]))+'</div></th>';
    }
    body += '</tr></thead><tbody>';
    for(var r=0;r<regsSorted.length;r++){
      var reg = regsSorted[r];
      body += '<tr><td>'+svgDot(reg.capColor, 12)+' <span><strong>'+esc(reg.name)+'</strong></span> <span class="small">('+esc(getCapLabel(reg)||'‚Äî')+', '+esc(eyeFull(reg.eye))+')</span>' + '<div class="small" style="font-weight:700"><div style="font-size:16px;font-weight:bold">' + frequencyLabelEN(reg.slots||[]) + '</div>' + (reg.notes && reg.notes.trim() ? ('<div class="small">'+esc(reg.notes)+'</div>') : '') + '</td>';
      for(var i=0;i<subset.length;i++){
        var slot2 = subset[i];
        if(slotHas(reg.slots||[], slot2)){
          body += '<td>'+svgDot(reg.capColor, 12)+' '+esc(getCapLabel(reg)||'')+' ‚Äî '+esc(eyeFull(reg.eye))+'</td>';
        } else {
          body += '<td><span class="small">‚Äî</span></td>';
        }
      }
      body += '</tr>';
    }
    body += '</tbody></table>';
    if(c < slotsChunks.length-1){ body += '<div class="small" style="margin:6px 0 12px">Continued ‚Üí</div>'; }
  }

  // Taper summary
  body += buildTaperSummaryHTML(payload);

  var foot = '<scr' + 'ipt>window.onload=function(){window.print(); setTimeout(function(){window.close();}, 200);};</scr' + 'ipt></body></html>';
  return head + body + foot;
}

// ------- PDF preview & export (canvas-based, preserves aspect) -------
var _pdfCache = { blobUrl: null, pages: 0 };
function revokePdfCache(){ try{ if(_pdfCache.blobUrl) URL.revokeObjectURL(_pdfCache.blobUrl); }catch(e){} _pdfCache = {blobUrl:null,pages:0}; }

function generatePdfAndPreview(doSave){
  return new Promise(function(resolve, reject){
    try {
      var payload = getPayload();
      var node = (function(){ // build printable container DOM for high-fidelity raster
        var container = document.createElement('div');
        container.style.background = '#fff';
        container.style.color = '#0f172a';
        container.style.font = '14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';
        container.style.webkitFontSmoothing = 'antialiased';
        container.style.textRendering = 'optimizeLegibility';
        var nameHeader = document.createElement('div');
        nameHeader.style.fontSize = '22pt';
        nameHeader.style.fontWeight = '700';
        nameHeader.style.margin = '0 0 10px 0';
        nameHeader.textContent = payload.patientName || '';
        if(nameHeader.textContent){ container.appendChild(nameHeader); }
        var dateDiv=document.createElement('div'); dateDiv.style.fontSize='16px'; dateDiv.style.fontWeight='600'; dateDiv.style.margin='0 0 10px 0'; dateDiv.textContent='Today\'s date: ' + (new Date()).toLocaleDateString(); container.appendChild(dateDiv);
        var wrap = document.createElement('div');
        renderPerMedTables(wrap, payload, {hidePatientLine:true});
        var taperHTML = buildTaperSummaryHTML(payload);
        if(taperHTML){ var div = document.createElement('div'); div.innerHTML = taperHTML; wrap.appendChild(div); }
        container.appendChild(wrap);
        // normalize tables
        var tables = container.querySelectorAll('table');
        for(var ti=0; ti<tables.length; ti++){ var t=tables[ti]; t.style.width='100%'; t.style.tableLayout='fixed'; t.style.borderCollapse='collapse'; var cells=t.querySelectorAll('th,td'); for(var ci=0; ci<cells.length; ci++){ var c=cells[ci]; c.style.padding='8px'; c.style.whiteSpace='normal'; c.style.wordBreak='break-word'; c.style.overflowWrap='anywhere'; } }
        return container;
      })();
      var host = document.createElement('div'); host.style.position='fixed'; host.style.left='-99999px'; host.style.top='0'; host.style.background='#fff';
      document.body.appendChild(host); host.appendChild(node);

      var jsPDFCtor = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
      if(!jsPDFCtor || !window.html2canvas){ throw new Error('PDF libs not loaded'); }
      var pdf = new jsPDFCtor({unit:'pt', format:'letter', compress:true});
      var pageWpt = pdf.internal.pageSize.getWidth();
      var pageHpt = pdf.internal.pageSize.getHeight();
      var margin = 36;
      var contentWpt = pageWpt - margin*2;
      var contentHpt = pageHpt - margin*2;
      var pxPerPt = 96/72;
      var contentWpx = Math.round(contentWpt * pxPerPt);
      node.style.width = contentWpx + 'px';

      html2canvas(node, {scale: 2, useCORS: true, backgroundColor: '#ffffff'}).then(function(canvas){
        var imgWpx = canvas.width, imgHpx = canvas.height;
        var k = contentWpt / imgWpx; // pt per px (preserve aspect)
        var pageHeightPx = Math.floor(contentHpt / k);

        var preview = byId('pdfPreview'); if(preview) preview.innerHTML='';
        var pageCount = 0, y = 0;
        while(y < imgHpx){
          var sliceHeight = Math.min(pageHeightPx, imgHpx - y);
          var pageCanvas = document.createElement('canvas'); pageCanvas.width = imgWpx; pageCanvas.height = sliceHeight;
          var ctx = pageCanvas.getContext('2d'); ctx.drawImage(canvas, 0, y, imgWpx, sliceHeight, 0, 0, imgWpx, sliceHeight);
          var imgData = pageCanvas.toDataURL('image/png');
          if(pageCount>0) pdf.addPage();
          var sliceHeightPt = sliceHeight * k;
          pdf.addImage(imgData, 'PNG', margin, margin, contentWpt, sliceHeightPt);

          if(preview){ var img=document.createElement('img'); img.src=imgData; img.style.width='100%'; img.style.height='auto'; img.style.border='1px solid var(--border)'; img.style.borderRadius='8px'; preview.appendChild(img); }

          y += sliceHeight; pageCount++;
        }
        revokePdfCache();
        var blob = pdf.output('blob'); var url = URL.createObjectURL(blob); _pdfCache.blobUrl = url; _pdfCache.pages = pageCount;
        var meta = byId('pdfMeta'); if(meta) meta.textContent = 'Preview ready: '+pageCount+' page'+(pageCount>1?'s':'')+'.';
        if(doSave){ var name=(payload.patientName||'patient').replace(/[^a-z0-9_\-]+/ig,'_'); var date=(new Date(payload.startDate)).toISOString().slice(0,10); pdf.save('schedule_'+name+'_'+date+'.pdf'); }
        document.body.removeChild(host);
        resolve({pages:pageCount,url:_pdfCache.blobUrl});
      }).catch(function(err){ document.body.removeChild(host); reject(err); });
    } catch(e){ reject(e); }
  });
}
byId('refreshPreview').onclick = function(){ var b=this; b.disabled=true; b.textContent='Rendering‚Ä¶'; generatePdfAndPreview(false).then(function(){ b.disabled=false; b.textContent='Refresh preview'; }).catch(function(err){ b.disabled=false; b.textContent='Refresh preview'; alert('Preview failed: '+(err&&err.message?err.message:err)); }); };
byId('downloadPdfBtn').onclick = function(){ if(_pdfCache.blobUrl){ var a=document.createElement('a'); a.href=_pdfCache.blobUrl; a.download='schedule.pdf'; a.click(); } else { generatePdfAndPreview(true).catch(function(err){ alert('Download failed: '+(err&&err.message?err.message:err)); }); } };

setOnclickIfPresent('printBtn', function () {
  generatePdfAndPreview(true).catch(function(err){
    try {
      var payload = getPayload();
      var html = generatePrintHTML(payload);
      var w = window.open('', '_blank', 'noopener,noreferrer,width=1000,height=800');
      if(w){ w.document.open(); w.document.write(html); w.document.close(); }
      else {
        var blob = new Blob([html], {type:'text/html'}); var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href=url; a.download='schedule.html'; a.click(); URL.revokeObjectURL(url);
        alert('Popup was blocked. Downloaded schedule.html instead‚Äîopen it to print.');
      }
    } catch(e2){ alert('Unable to generate PDF or open print view: ' + (err && err.message ? err.message : err)); }
  });
});


// ===== Preview language toggle (independent of print buttons) =====
(function(){
  var enBtn = byId('toggleEN'), esBtn = byId('toggleES');
  function setLang(lang){
    PREVIEW_LANG = lang;
    if(enBtn){ enBtn.setAttribute('aria-pressed', String(lang==='en')); }
    if(esBtn){ esBtn.setAttribute('aria-pressed', String(lang==='es')); }
    // Re-render preview card
    renderPrintable();
    // Also regenerate the preview image stack to reflect chosen language
    var meta = byId('pdfMeta'); if(meta) meta.textContent = 'Rendering preview‚Ä¶';
    generatePreviewOnly().then(function(pages){
      if(meta) meta.textContent = 'Preview ready: '+pages+' page'+(pages>1?'s':'');
    }).catch(function(err){
      if(meta) meta.textContent = 'Preview error: ' + (err && err.message ? err.message : err);
    });
  }
  if(enBtn){ enBtn.onclick=function(){ setLang('en'); }; }
  if(esBtn){ esBtn.onclick=function(){ setLang('es'); }; }
})();

// Generate preview pages without saving; uses PREVIEW_LANG
function generatePreviewOnly(){
  return new Promise(function(resolve, reject){
    try {
      var payload = getPayload();
      var node = (function(){ // build printable DOM according to language
        var container = document.createElement('div');
        container.style.background = '#fff';
        container.style.color = '#0f172a';
        container.style.font = '14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';
        var wrap = document.createElement('div');
        if(PREVIEW_LANG==='es'){ renderPerMedTables_ES(wrap, payload, {hidePatientLine:true}); wrap.innerHTML += buildTaperSummaryHTML_ES(payload); }
        else { renderPerMedTables(wrap, payload, {hidePatientLine:true}); wrap.innerHTML += buildTaperSummaryHTML(payload); }
        container.appendChild(wrap);
        var tables = container.querySelectorAll('table');
        for(var ti=0; ti<tables.length; ti++){ var t=tables[ti]; t.style.width='100%'; t.style.tableLayout='fixed'; t.style.borderCollapse='collapse'; var cells=t.querySelectorAll('th,td'); for(var ci=0; ci<cells.length; ci++){ var c=cells[ci]; c.style.padding='8px'; c.style.whiteSpace='normal'; c.style.wordBreak='break-word'; c.style.overflowWrap='anywhere'; } }
        return container;
      })();
      var host = document.createElement('div'); host.style.position='fixed'; host.style.left='-99999px'; host.style.top='0'; host.style.background='#fff';
      document.body.appendChild(host); host.appendChild(node);

      var jsPDFCtor = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
      if(!window.html2canvas){ throw new Error('Canvas lib not loaded'); }
      var pageWpt = 612; var pageHpt = 792; // letter in points
      var margin = 36;
      var contentWpt = pageWpt - margin*2;
      var contentHpt = pageHpt - margin*2;
      var pxPerPt = 96/72;
      var contentWpx = Math.round(contentWpt * pxPerPt);
      node.style.width = contentWpx + 'px';

      html2canvas(node, {scale: 2, useCORS: true, backgroundColor: '#ffffff'}).then(function(canvas){
        var imgWpx = canvas.width, imgHpx = canvas.height;
        var k = contentWpt / imgWpx;
        var pageHeightPx = Math.floor(contentHpt / k);

        var preview = byId('pdfPreview'); if(preview) preview.innerHTML='';
        var pageCount = 0, y = 0;
        while(y < imgHpx){
          var sliceHeight = Math.min(pageHeightPx, imgHpx - y);
          var pageCanvas = document.createElement('canvas'); pageCanvas.width = imgWpx; pageCanvas.height = sliceHeight;
          var ctx = pageCanvas.getContext('2d'); ctx.drawImage(canvas, 0, y, imgWpx, sliceHeight, 0, 0, imgWpx, sliceHeight);
          var imgData = pageCanvas.toDataURL('image/png');
          if(preview){ var img=document.createElement('img'); img.src=imgData; img.style.width='100%'; img.style.height='auto'; img.style.border='1px solid var(--border)'; img.style.borderRadius='8px'; preview.appendChild(img); }
          y += sliceHeight; pageCount++;
        }
        document.body.removeChild(host);
        resolve(pageCount);
      }).catch(function(err){ document.body.removeChild(host); reject(err); });
    } catch(e){ reject(e); }
  });
}

// ----- Bilingual print buttons (independent of toggle) -----
(function(){
  var enBtn = byId('printBtnEn');
  if(enBtn){
    enBtn.onclick = function(){
      generatePdfAndPreview(true).catch(function(err){
        try{
          var payload = getPayload();
          var html = generatePrintHTML(payload);
          var w = window.open('', '_blank', 'noopener,noreferrer,width=1000,height=800');
          if(w){ w.document.open(); w.document.write(html); w.document.close(); }
          else {
            var blob = new Blob([html], {type:'text/html'}); var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href=url; a.download='schedule.html'; a.click(); URL.revokeObjectURL(url);
            alert('Popup was blocked. Downloaded schedule.html instead‚Äîopen it to print.');
          }
        } catch(e2){ alert('Unable to generate PDF or open print view: ' + (err && err.message ? err.message : err)); }
      });
    };
  }
  var esBtn = byId('printBtnEs');
  if(esBtn){
    esBtn.onclick = function(){
      generatePdfAndPreview_ES(true).catch(function(err){
        try{
          var payload = getPayload();
          var html = generatePrintHTML_ES(payload);
          var w = window.open('', '_blank', 'noopener,noreferrer,width=1000,height=800');
          if(w){ w.document.open(); w.document.write(html); w.document.close(); }
          else {
            var blob = new Blob([html], {type:'text/html'}); var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href=url; a.download='horario.html'; a.click(); URL.revokeObjectURL(url);
            alert('Se bloque√≥ la ventana emergente. Se descarg√≥ horario.html; √°bralo para imprimir.');
          }
        } catch(e2){ alert('No se pudo generar el PDF o abrir la vista de impresi√≥n: ' + (err && err.message ? err.message : err)); }
      });
    };
  }
})();

// ---------------- Events ----------------
byId('addCustomMedBtn').onclick = function () {
  var name = prompt('Medication name (brand/generic + class):'); if(!name) return;
  var capColor = prompt('Cap color (e.g., teal, yellow, purple):','') || '';
  var capLabel = prompt('Cap label text (optional, e.g., Tube):','') || '';
  var cls = prompt('Medication class (e.g., Steroid, NSAID, Glaucoma, Antibiotic):','') || '';
  var id = name.toLowerCase().replace(/[^a-z0-9]+/g,'-');
  catalog.push({id:id,name:name,capColor:capColor,capLabel:capLabel||undefined,medClass:cls,freqPresets:[]}); renderCatalog();
};
['patientName','startDate','durationDays','t_morning','t_noon','t_evening','t_bedtime'].forEach(function(id){
  byId(id).addEventListener('input', function(){ renderQR(); renderPrintable(); });
});
byId('downloadJsonBtn').onclick = function (){
  var payload = getPayload();
  download('schedule-' + (payload.patientName||'patient') + '.json', JSON.stringify(payload,null,2));
};

// ---------------- Init ----------------
(function init(){
  try{
    var today = new Date().toISOString().slice(0,10);
    byId('startDate').value = today;
    renderCatalog();
    renderSelected();
    buildFilterUI();
  }catch(e){
    alert('Initialization error: ' + e.message);
  }
})();
</script>

</body>
</html>